name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        default: 'v0.1.0'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: tasky-windows-x64.exe

          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: tasky-linux-x64

          - target: x86_64-apple-darwin
            os: macos-latest
            name: tasky-macos-x64

          - target: aarch64-apple-darwin
            os: macos-latest
            name: tasky-macos-arm64

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Install dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Build
      run: cargo build --release --target ${{ matrix.target }}

    - name: Prepare binary (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        copy "target\${{ matrix.target }}\release\tasky.exe" "${{ matrix.name }}"

    - name: Prepare binary (Unix)
      if: matrix.os != 'windows-latest'
      run: |
        cp "target/${{ matrix.target }}/release/tasky" "${{ matrix.name }}"
        chmod +x "${{ matrix.name }}"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.name }}
        path: ${{ matrix.name }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: List artifacts
      run: find artifacts -type f

    - name: Get tag name
      id: tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Tasky ${{ steps.tag.outputs.tag }}
        body: |
          ## ğŸ‰ Tasky ${{ steps.tag.outputs.tag }} ë¦´ë¦¬ì¦ˆ

          ### ğŸ“¦ ë‹¤ìš´ë¡œë“œ
          ìš´ì˜ì²´ì œì— ë§ëŠ” ì‹¤í–‰íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”:

          - **Windows (x64)**: `tasky-windows-x64.exe`
          - **Linux (x64)**: `tasky-linux-x64`
          - **macOS (Intel)**: `tasky-macos-x64`
          - **macOS (Apple Silicon)**: `tasky-macos-arm64`

          ### ğŸš€ ì„¤ì¹˜ ë°©ë²•

          #### Windows
          1. `tasky-windows-x64.exe`ë¥¼ ë‹¤ìš´ë¡œë“œ
          2. ì›í•˜ëŠ” í´ë”ì— ì €ì¥ (ì˜ˆ: `C:\tools\`)
          3. í™˜ê²½ë³€ìˆ˜ PATHì— í•´ë‹¹ í´ë” ì¶”ê°€
          4. ìƒˆ ëª…ë ¹ í”„ë¡¬í”„íŠ¸ì—ì„œ `tasky --help` ì‹¤í–‰

          #### Linux/macOS
          ```bash
          # ë‹¤ìš´ë¡œë“œ (Linux ì˜ˆì‹œ)
          wget https://github.com/TechieQuokka/Tasky/releases/download/${{ steps.tag.outputs.tag }}/tasky-linux-x64

          # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x tasky-linux-x64

          # /usr/local/binìœ¼ë¡œ ì´ë™ (ì„ íƒì‚¬í•­)
          sudo mv tasky-linux-x64 /usr/local/bin/tasky

          # í…ŒìŠ¤íŠ¸
          tasky --help
          ```

          ### âœ¨ ì£¼ìš” ê¸°ëŠ¥
          - í• ì¼ ìƒì„±, ìˆ˜ì •, ì‚­ì œ
          - ìš°ì„ ìˆœìœ„ ì„¤ì • (high, medium, low)
          - ë§ˆê°ì¼ ê´€ë¦¬
          - ìƒíƒœ ì¶”ì  (pending, done)
          - í†µê³„ ë° ì§„í–‰ë¥  í™•ì¸
          - ê²¬ê³ í•œ ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬

          ìì„¸í•œ ì‚¬ìš©ë²•ì€ [README](https://github.com/TechieQuokka/Tasky/blob/master/README.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
        files: |
          artifacts/tasky-windows-x64.exe/tasky-windows-x64.exe
          artifacts/tasky-linux-x64/tasky-linux-x64
          artifacts/tasky-macos-x64/tasky-macos-x64
          artifacts/tasky-macos-arm64/tasky-macos-arm64
        draft: false
        prerelease: false